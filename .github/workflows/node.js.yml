name: Deploy Backend

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Copy backend files (DO NOT delete .env)
      - name: Copy files to app directory
        run: |
          echo "üìÅ Syncing backend files..."
          mkdir -p /home/ubuntu/app

          rsync -av --delete \
            --exclude='.env' \
            --exclude='node_modules' \
            --exclude='.git' \
            ./backend/ /home/ubuntu/app/

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          cd /home/ubuntu/app
          rm -rf node_modules package-lock.json
          npm install --production

      # 4Ô∏è‚É£ PM2 Restart (safe)
      - name: Restart PM2 process
        run: |
          echo "üöÄ Restarting backend with PM2..."
          cd /home/ubuntu/app

          pm2 stop unified-backend || true
          pm2 delete unified-backend || true

          pm2 start ecosystem.config.js --env production
          pm2 save

      # 5Ô∏è‚É£ PM2 Status (for logs)
      - name: PM2 status
        run: |
          pm2 status
